# 异步导入

## 业务逻辑设计

导入配置表`t_infra_import_config`，主键为`system_code`+`task_code`，配置单条导入任务的字段映射、导入处理类类名。

导入任务表`t_infra_import_task`，`system_code`+`task_code`+`insert_user`，记录每次用户操作的导入任务的状态信息。

1. 用户在页面上点击导入，弹出导入操作框，提供下载模板、上传文件按钮。每次打开导入操作框时，根据`system_code`+`task_code`+`insert_user`查询最近一条导入任务，获取任务状态，如无任务或任务状态不在进行中时，可提交新任务。

2. 点击上传文件按钮，浏览本地文件，选择文件上传后，插入一条导入任务，初始状态为待校验；同时向消息队列中插入一条导入任务，导入的mqHandler获取到任务后开始处理：

   > 获取到导入任务后，若任务状态为`待校验`，则将任务状态置为`校验中`开始校验流程；若任务状态为`待导入`，则将任务状态置为`导入中`开始导入流程。

   - 根据主键查询导入配置表，拿到需要组装的目标实体、目标`importHandler`类，通过反射从Spring容器中获取`handler`实例，然后根据导入任务中的文件地址，从文件服务器中下载文件到临时目录，根据任务的状态`待校验/待导入`，分别调用`handler`实例的`checkData`方法或`persistData`方法。
   - `checkData`方法执行结束后，将该任务状态置为`待导入、校验异常、部分校验错误、全部错误、部分校验警告`几种状态。如果任务状态为`待导入`，则往消息队列中插入一条导入任务。
   - `persistData`方法执行结束后，将该任务状态置为`导入成功、导入异常`两种状态。